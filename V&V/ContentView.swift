//
//  ContentView.swift
//  Firs IÃáos
//
//  Created by Atilla K√∂z on 26.12.2024.
//

import SwiftUI
import AVFoundation
import AudioToolbox

// Oyuncu modeli
struct Player: Identifiable {
    let id = UUID()
    var name: String
    var role: GameRole?
    var isDead: Bool = false
}

// Oyun rolleri
enum GameRole: String, CaseIterable, Identifiable {
    case vampir = "üßõ"
    case k√∂yl√º = "üë®‚Äçüåæ"
    case masumK√∂yl√º = "üòá"
    case kahin = "üîÆ"
    case doktor = "üë®‚Äç‚öïÔ∏è"
    case avcƒ± = "üèπ"
    case b√ºy√ºc√º = "üßô‚Äç‚ôÇÔ∏è"
    case custom = "‚ùì"
    
    var id: String { self.rawValue }
    
    func localizedName(language: Language, customRoleName: String?) -> String {
        if self == .custom {
            return "‚ùì \(customRoleName ?? self.rawValue)"
        }
        let key = "role_\(self)_name"
        return "\(self.rawValue) \(Translations.text(for: key, language: language))"
    }
    
    func localizedDescription(language: Language, customRoleDescription: String?) -> String {
        if self == .custom {
            return customRoleDescription ?? ""
        }
        let key = "role_\(self)_description"
        return Translations.text(for: key, language: language)
    }
    
    var backgroundColor: Color {
        switch self {
        case .vampir: return .red
        case .k√∂yl√º: return .brown
        case .masumK√∂yl√º: return Color(red: 0.9, green: 0.7, blue: 0.3)
        case .kahin: return Color(red: 0.4, green: 0.2, blue: 0.6)
        case .doktor: return .blue
        case .avcƒ±: return .green
        case .b√ºy√ºc√º: return .purple
        case .custom: return Color(red: 0.6, green: 0.4, blue: 0.8)
        }
    }
}

// Dil se√ßenekleri
enum Language: String, CaseIterable {
    case turkish = "T√ºrk√ße"
    case english = "English"
    case german = "Deutsch"
    case french = "Fran√ßais"
    case spanish = "Espa√±ol"
    
    var flagEmoji: String {
        switch self {
        case .turkish: return "üáπüá∑"
        case .english: return "üá¨üáß"
        case .german: return "üá©üá™"
        case .french: return "üá´üá∑"
        case .spanish: return "üá™üá∏"
        }
    }
}

// √áeviriler
struct Translations {
    static func text(for key: String, language: Language) -> String {
        switch language {
        case .turkish:
            return turkishTexts[key] ?? key
        case .english:
            return englishTexts[key] ?? key
        case .german:
            return germanTexts[key] ?? key
        case .french:
            return frenchTexts[key] ?? key
        case .spanish:
            return spanishTexts[key] ?? key
        }
    }
    
    static let turkishTexts: [String: String] = [
        "title": "Vampir K√∂yl√º",
        "settings": "Ayarlar",
        "language": "Dil Se√ßimi",
        "done": "Tamam",
        "player_name": "Oyuncu Adƒ±",
        "distribute_roles": "Rolleri Daƒüƒ±t",
        "redistribute_roles": "Yeniden Daƒüƒ±t",
        "reset": "Sƒ±fƒ±rla",
        "delete_all": "T√ºm√ºn√º Sil",
        "delete_all_warning": "T√ºm oyuncular silinecek. Bu i≈ülem geri alƒ±namaz. Emin misiniz?",
        "cancel": "ƒ∞ptal",
        "delete": "Sil",
        "roles": "Roller",
        "role_distribution": "Rol Daƒüƒ±lƒ±mƒ±",
        "redistribute_warning": "Mevcut roller silinecek ve yeniden daƒüƒ±tƒ±lacak. Emin misiniz?",
        "delete_player_warning": "isimli oyuncuyu silmek istediƒüinize emin misiniz?",
        "delete_player": "Oyuncuyu Sil",
        "close": "Kapat",
        "add_custom_role": "√ñzel Rol Ekle",
        "custom_role_name": "Rol Adƒ±",
        "custom_role_description": "Rol A√ßƒ±klamasƒ±",
        "add": "Ekle",
        "role_vampir_name": "Vampir",
        "role_k√∂yl√º_name": "K√∂yl√º",
        "role_masumK√∂yl√º_name": "Masum K√∂yl√º",
        "role_kahin_name": "Kahin",
        "role_doktor_name": "Doktor",
        "role_avcƒ±_name": "Avcƒ±",
        "role_b√ºy√ºc√º_name": "B√ºy√ºc√º",
        "role_vampir_description": "Geceleri k√∂yl√ºleri √∂ld√ºr√ºr",
        "role_k√∂yl√º_description": "Vampirleri bulmaya √ßalƒ±≈üƒ±r",
        "role_masumK√∂yl√º_description": "Gece olduƒüunda diƒüer vampirlere belli etmeden g√∂zlerini a√ßabilir",
        "role_kahin_description": "Her gece bir ki≈üinin rol√ºn√º √∂ƒürenebilir",
        "role_doktor_description": "Her gece bir ki≈üiyi iyile≈ütirir",
        "role_avcƒ±_description": "Bir ki≈üiyi √∂ld√ºrme hakkƒ± var",
        "role_b√ºy√ºc√º_description": "Bir kez diriltme, bir kez √∂ld√ºrme hakkƒ± var",
        "timer_settings": "Saya√ß Ayarlarƒ±",
        "timer_enabled": "Saya√ß Aktif",
        "timer_duration": "S√ºre (saniye)",
        "minutes": "dakika",
        "seconds": "saniye",
        "sound_enabled": "Ses Aktif"
    ]
    
    static let englishTexts: [String: String] = [
        "title": "Vampire Village",
        "settings": "Settings",
        "language": "Language",
        "done": "Done",
        "player_name": "Player Name",
        "distribute_roles": "Distribute Roles",
        "redistribute_roles": "Redistribute",
        "reset": "Reset",
        "delete_all": "Delete All",
        "delete_all_warning": "All players will be deleted. This action cannot be undone. Are you sure?",
        "cancel": "Cancel",
        "delete": "Delete",
        "roles": "Roles",
        "role_distribution": "Role Distribution",
        "redistribute_warning": "Current roles will be deleted and redistributed. Are you sure?",
        "delete_player_warning": "Are you sure you want to delete player",
        "delete_player": "Delete Player",
        "close": "Close",
        "add_custom_role": "Add Custom Role",
        "custom_role_name": "Role Name",
        "custom_role_description": "Role Description",
        "add": "Add",
        "role_vampir_name": "Vampire",
        "role_k√∂yl√º_name": "Villager",
        "role_masumK√∂yl√º_name": "Innocent Villager",
        "role_kahin_name": "Seer",
        "role_doktor_name": "Doctor",
        "role_avcƒ±_name": "Hunter",
        "role_b√ºy√ºc√º_name": "Wizard",
        "role_vampir_description": "Kills villagers at night",
        "role_k√∂yl√º_description": "Tries to find vampires",
        "role_masumK√∂yl√º_description": "Can open eyes at night without being noticed by vampires",
        "role_kahin_description": "Can learn one person's role each night",
        "role_doktor_description": "Heals one person each night",
        "role_avcƒ±_description": "Has the right to kill one person",
        "role_b√ºy√ºc√º_description": "Has one resurrection and one kill right",
        "timer_settings": "Timer Settings",
        "timer_enabled": "Timer Enabled",
        "timer_duration": "Duration (seconds)",
        "minutes": "minutes",
        "seconds": "seconds",
        "sound_enabled": "Sound Enabled"
    ]
    
    static let germanTexts: [String: String] = [
        "title": "Vampirdorf",
        "settings": "Einstellungen",
        "language": "Sprache",
        "done": "Fertig",
        "player_name": "Spielername",
        "distribute_roles": "Rollen verteilen",
        "redistribute_roles": "Neu verteilen",
        "reset": "Zur√ºcksetzen",
        "delete_all": "Alle l√∂schen",
        "delete_all_warning": "Alle Spieler werden gel√∂scht. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden. Sind Sie sicher?",
        "cancel": "Abbrechen",
        "delete": "L√∂schen",
        "roles": "Rollen",
        "role_distribution": "Rollenverteilung",
        "redistribute_warning": "Aktuelle Rollen werden gel√∂scht und neu verteilt. Sind Sie sicher?",
        "delete_player_warning": "Sind Sie sicher, dass Sie den Spieler l√∂schen m√∂chten",
        "delete_player": "Spieler l√∂schen",
        "close": "Schlie√üen",
        "add_custom_role": "Benutzerdefinierte Rolle hinzuf√ºgen",
        "custom_role_name": "Rollenname",
        "custom_role_description": "Rollenbeschreibung",
        "add": "Hinzuf√ºgen",
        "role_vampir_name": "Vampir",
        "role_k√∂yl√º_name": "Dorfbewohner",
        "role_masumK√∂yl√º_name": "Unschuldiger Dorfbewohner",
        "role_kahin_name": "Seher",
        "role_doktor_name": "Arzt",
        "role_avcƒ±_name": "J√§ger",
        "role_b√ºy√ºc√º_name": "Zauberer",
        "role_vampir_description": "T√∂tet nachts Dorfbewohner",
        "role_k√∂yl√º_description": "Versucht Vampire zu finden",
        "role_masumK√∂yl√º_description": "Kann nachts die Augen √∂ffnen, ohne von Vampiren bemerkt zu werden",
        "role_kahin_description": "Kann jede Nacht die Rolle einer Person erfahren",
        "role_doktor_description": "Heilt jede Nacht eine Person",
        "role_avcƒ±_description": "Hat das Recht, eine Person zu t√∂ten",
        "role_b√ºy√ºc√º_description": "Hat ein Wiederbelebungsrecht und ein T√∂tungsrecht",
        "timer_settings": "Timer-Einstellungen",
        "timer_enabled": "Timer Aktiviert",
        "timer_duration": "Dauer (Sekunden)",
        "minutes": "Minuten",
        "seconds": "Sekunden",
        "sound_enabled": "Ton Aktiviert"
    ]
    
    static let frenchTexts: [String: String] = [
        "title": "Village Vampire",
        "settings": "Param√®tres",
        "language": "Langue",
        "done": "Termin√©",
        "player_name": "Nom du joueur",
        "distribute_roles": "Distribuer les r√¥les",
        "redistribute_roles": "Redistribuer",
        "reset": "R√©initialiser",
        "delete_all": "Tout supprimer",
        "delete_all_warning": "Tous les joueurs seront supprim√©s. Cette action ne peut pas √™tre annul√©e. √ätes-vous s√ªr?",
        "cancel": "Annuler",
        "delete": "Supprimer",
        "roles": "R√¥les",
        "role_distribution": "Distribution des r√¥les",
        "redistribute_warning": "Les r√¥les actuels seront supprim√©s et redistribu√©s. √ätes-vous s√ªr?",
        "delete_player_warning": "√ätes-vous s√ªr de vouloir supprimer le joueur",
        "delete_player": "Supprimer le joueur",
        "close": "Fermer",
        "add_custom_role": "Ajouter un r√¥le personnalis√©",
        "custom_role_name": "Nom du r√¥le",
        "custom_role_description": "Description du r√¥le",
        "add": "Ajouter",
        "role_vampir_name": "Vampire",
        "role_k√∂yl√º_name": "Villageois",
        "role_masumK√∂yl√º_name": "Villageois Innocent",
        "role_kahin_name": "Voyant",
        "role_doktor_name": "M√©decin",
        "role_avcƒ±_name": "Chasseur",
        "role_b√ºy√ºc√º_name": "Sorcier",
        "role_vampir_description": "Tue les villageois la nuit",
        "role_k√∂yl√º_description": "Essaie de trouver les vampires",
        "role_masumK√∂yl√º_description": "Peut ouvrir les yeux la nuit sans √™tre remarqu√© par les vampires",
        "role_kahin_description": "Peut d√©couvrir le r√¥le d'une personne chaque nuit",
        "role_doktor_description": "Soigne une personne chaque nuit",
        "role_avcƒ±_description": "A le droit de tuer une personne",
        "role_b√ºy√ºc√º_description": "A un droit de r√©surrection et un droit de mort",
        "timer_settings": "Param√®tres du minuteur",
        "timer_enabled": "Minuteur activ√©",
        "timer_duration": "Dur√©e (secondes)",
        "minutes": "minutes",
        "seconds": "secondes",
        "sound_enabled": "Son Activ√©"
    ]
    
    static let spanishTexts: [String: String] = [
        "title": "Pueblo Vampiro",
        "settings": "Ajustes",
        "language": "Idioma",
        "done": "Listo",
        "player_name": "Nombre del jugador",
        "distribute_roles": "Distribuir roles",
        "redistribute_roles": "Redistribuir",
        "reset": "Reiniciar",
        "delete_all": "Eliminar todo",
        "delete_all_warning": "Se eliminar√°n todos los jugadores. Esta acci√≥n no se puede deshacer. ¬øEst√°s seguro?",
        "cancel": "Cancelar",
        "delete": "Eliminar",
        "roles": "Roles",
        "role_distribution": "Distribuci√≥n de roles",
        "redistribute_warning": "Los roles actuales se eliminar√°n y redistribuir√°n. ¬øEst√°s seguro?",
        "delete_player_warning": "¬øEst√°s seguro de que quieres eliminar al jugador",
        "delete_player": "Eliminar jugador",
        "close": "Cerrar",
        "add_custom_role": "Agregar rol personalizado",
        "custom_role_name": "Nombre del rol",
        "custom_role_description": "Descripci√≥n del rol",
        "add": "Agregar",
        "role_vampir_name": "Vampiro",
        "role_k√∂yl√º_name": "Aldeano",
        "role_masumK√∂yl√º_name": "Aldeano Inocente",
        "role_kahin_name": "Vidente",
        "role_doktor_name": "Doctor",
        "role_avcƒ±_name": "Cazador",
        "role_b√ºy√ºc√º_name": "Mago",
        "role_vampir_description": "Mata a los aldeanos por la noche",
        "role_k√∂yl√º_description": "Intenta encontrar vampiros",
        "role_masumK√∂yl√º_description": "Puede abrir los ojos por la noche sin ser notado por los vampiros",
        "role_kahin_description": "Puede conocer el rol de una persona cada noche",
        "role_doktor_description": "Cura a una persona cada noche",
        "role_avcƒ±_description": "Tiene el derecho de matar a una persona",
        "role_b√ºy√ºc√º_description": "Tiene un derecho de resurrecci√≥n y un derecho de muerte",
        "timer_settings": "Ajustes del temporizador",
        "timer_enabled": "Temporizador activado",
        "timer_duration": "Duraci√≥n (segundos)",
        "minutes": "minutos",
        "seconds": "segundos",
        "sound_enabled": "Sonido Activado"
    ]
}

// ViewModel
class GameViewModel: ObservableObject {
    @Published var players: [Player] = []
    @Published var selectedLanguage: Language = .turkish
    @Published var customRoleName: String?
    @Published var customRoleDescription: String?
    @Published var isTimerEnabled: Bool = true
    @Published var timerDuration: Int = 180 // 3 dakika varsayƒ±lan
    @Published var remainingTime: Int = 180
    @Published var isTimerRunning: Bool = false
    @Published var roleDistribution: [GameRole: Int] = [
        .vampir: 2,
        .k√∂yl√º: 3,
        .masumK√∂yl√º: 1,
        .kahin: 1,
        .doktor: 1,
        .avcƒ±: 1,
        .b√ºy√ºc√º: 1
    ]
    
    private func playVibration() {
        AudioServicesPlayAlertSoundWithCompletion(SystemSoundID(kSystemSoundID_Vibrate)) { }
    }
    
    func startTimer() {
        remainingTime = timerDuration
        isTimerRunning = true
        
        Timer.scheduledTimer(withTimeInterval: 1, repeats: true) { timer in
            if self.remainingTime > 0 && self.isTimerRunning {
                self.remainingTime -= 1
                
                // Son 30 saniye kaldƒ±ƒüƒ±nda titre≈üim
                if self.remainingTime == 30 {
                    self.playVibration()
                }
                
                // S√ºre bittiƒüinde titre≈üim
                if self.remainingTime == 0 {
                    self.playVibration()
                    timer.invalidate()
                    self.isTimerRunning = false
                }
            } else {
                timer.invalidate()
                self.isTimerRunning = false
            }
        }
    }
    
    func stopTimer() {
        isTimerRunning = false
    }
    
    func resetTimer() {
        remainingTime = timerDuration
        isTimerRunning = false
    }
    
    var hasDistributedRoles: Bool {
        players.contains { $0.role != nil }
    }
    
    func addPlayer(name: String) {
        let player = Player(name: name)
        players.append(player)
    }
    
    func removePlayer(at offsets: IndexSet) {
        players.remove(atOffsets: offsets)
    }
    
    func distributeRoles() {
        var availableRoles: [GameRole] = []
        
        // Rol daƒüƒ±lƒ±mƒ±na g√∂re rolleri olu≈ütur
        for (role, count) in roleDistribution {
            for _ in 0..<count {
                availableRoles.append(role)
            }
        }
        
        // Rolleri karƒ±≈ütƒ±r
        availableRoles.shuffle()
        
        // Her oyuncuya rol ata
        for i in 0..<min(players.count, availableRoles.count) {
            players[i].role = availableRoles[i]
        }
    }
    
    func resetRoles() {
        for i in 0..<players.count {
            players[i].role = nil
        }
    }
}

// Ekran boyutlarƒ± i√ßin yardƒ±mcƒ± extension
extension UIScreen {
    static var screenWidth: CGFloat {
        UIScreen.main.bounds.width
    }
    
    static var screenHeight: CGFloat {
        UIScreen.main.bounds.height
    }
    
    static var isSmallDevice: Bool {
        UIScreen.screenHeight < 700 // iPhone SE gibi k√º√ß√ºk cihazlar i√ßin
    }
}

struct ContentView: View {
    @StateObject private var viewModel = GameViewModel()
    @State private var newPlayerName = ""
    @State private var showingRoleSheet = false
    @State private var showingDistributionSheet = false
    @State private var showingRedistributeAlert = false
    @State private var showingDeleteAlert = false
    @State private var playerToDelete: Player? = nil
    @State private var showingDeleteAllAlert = false
    @State private var showingSettingsSheet = false
    
    var body: some View {
        NavigationView {
            GeometryReader { geometry in
                ZStack {
                    // Orta√ßaƒü temalƒ± arka plan gradyanƒ±
                    LinearGradient(
                        gradient: Gradient(colors: [
                            Color(red: 0.4, green: 0.2, blue: 0.1),
                            Color(red: 0.2, green: 0.1, blue: 0.1)
                        ]),
                        startPoint: .top,
                        endPoint: .bottom
                    )
                    .ignoresSafeArea()
                    
                    // S√ºsl√º arka plan deseni
                    Image(systemName: "seal.fill")
                        .resizable()
                        .aspectRatio(contentMode: .fit)
                        .foregroundColor(.white.opacity(0.03))
                        .frame(width: geometry.size.width * 0.4)
                        .rotationEffect(.degrees(45))
                        .position(x: geometry.size.width * 0.8, y: geometry.size.height * 0.2)
                    
                    VStack(spacing: geometry.size.height * 0.02) {
                        Text(Translations.text(for: "title", language: viewModel.selectedLanguage))
                            .font(.custom("Copperplate", size: 36))
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                            .padding(.top, geometry.size.height * 0.05)
                            .padding(.bottom, geometry.size.height * 0.04)
                            .shadow(color: .black.opacity(0.5), radius: 2)
                        
                        // Oyuncu ekleme alanƒ±
                        HStack {
                            TextField(Translations.text(for: "player_name", language: viewModel.selectedLanguage), text: $newPlayerName)
                                .textFieldStyle(MedievalTextFieldStyle())
                                .font(.custom("Georgia", size: UIScreen.isSmallDevice ? 14 : 16))
                                .frame(height: geometry.size.height * 0.06)
                            
                            Button(action: {
                                if !newPlayerName.isEmpty {
                                    viewModel.addPlayer(name: newPlayerName)
                                    newPlayerName = ""
                                }
                            }) {
                                Image(systemName: "plus.circle.fill")
                                    .font(.system(size: geometry.size.width * 0.1))
                                    .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                            }
                        }
                        .padding(.horizontal, geometry.size.width * 0.04)
                        
                        // Oyuncu listesi
                        ScrollView {
                            LazyVStack(spacing: geometry.size.height * 0.015) {
                                ForEach(viewModel.players) { player in
                                    PlayerRow(player: player)
                                        .environmentObject(viewModel)
                                        .transition(.scale.combined(with: .opacity))
                                        .onTapGesture {
                                            if let index = viewModel.players.firstIndex(where: { $0.id == player.id }) {
                                                viewModel.players[index].isDead.toggle()
                                            }
                                        }
                                        .swipeActions(edge: .trailing, allowsFullSwipe: true) {
                                            Button(role: .destructive) {
                                                withAnimation {
                                                    if let index = viewModel.players.firstIndex(where: { $0.id == player.id }) {
                                                        viewModel.players.remove(at: index)
                                                    }
                                                }
                                            } label: {
                                                Label("Sil", systemImage: "trash")
                                            }
                                        }
                                }
                            }
                            .padding(.horizontal, geometry.size.width * 0.04)
                        }
                        
                        // Butonlar
                        HStack(spacing: geometry.size.width * 0.04) {
                            Button(action: {
                                withAnimation {
                                    if viewModel.hasDistributedRoles {
                                        showingRedistributeAlert = true
                                    } else {
                                        viewModel.distributeRoles()
                                        showingRoleSheet = true
                                    }
                                }
                            }) {
                                HStack {
                                    Image(systemName: "scroll.fill")
                                    Text(viewModel.hasDistributedRoles ? 
                                        Translations.text(for: "redistribute_roles", language: viewModel.selectedLanguage) : 
                                        Translations.text(for: "distribute_roles", language: viewModel.selectedLanguage))
                                        .font(.custom("Georgia", size: 16))
                                }
                                .frame(maxWidth: .infinity)
                                .padding()
                                .background(
                                    RoundedRectangle(cornerRadius: 15)
                                        .fill(Color(red: 0.8, green: 0.7, blue: 0.3))
                                        .overlay(
                                            RoundedRectangle(cornerRadius: 15)
                                                .stroke(Color(red: 0.9, green: 0.8, blue: 0.4), lineWidth: 1)
                                        )
                                )
                                .foregroundColor(Color(red: 0.2, green: 0.1, blue: 0.1))
                                .shadow(color: Color.black.opacity(0.3), radius: 5)
                            }
                            .disabled(viewModel.players.isEmpty)

                            Button(action: {
                                withAnimation {
                                    if viewModel.hasDistributedRoles {
                                        viewModel.resetRoles()
                                    } else {
                                        showingDeleteAllAlert = true
                                    }
                                }
                            }) {
                                HStack {
                                    Image(systemName: viewModel.hasDistributedRoles ? "xmark.seal.fill" : "trash.fill")
                                    Text(viewModel.hasDistributedRoles ? 
                                        Translations.text(for: "reset", language: viewModel.selectedLanguage) : 
                                        Translations.text(for: "delete_all", language: viewModel.selectedLanguage))
                                        .font(.custom("Georgia", size: 16))
                                }
                                .frame(maxWidth: .infinity)
                                .padding()
                                .background(
                                    RoundedRectangle(cornerRadius: 15)
                                        .fill(Color(red: 0.5, green: 0.2, blue: 0.2))
                                        .overlay(
                                            RoundedRectangle(cornerRadius: 15)
                                                .stroke(Color(red: 0.6, green: 0.3, blue: 0.3), lineWidth: 1)
                                        )
                                )
                                .foregroundColor(.white)
                                .shadow(color: Color.black.opacity(0.3), radius: 5)
                            }
                            .disabled(viewModel.players.isEmpty)
                        }
                        .padding(.horizontal, geometry.size.width * 0.04)
                        .padding(.bottom, geometry.size.height * 0.02)
                    }
                }
            }
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button(action: { showingSettingsSheet = true }) {
                        Image(systemName: "gearshape.fill")
                            .font(.title2)
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                    }
                }
                
                if viewModel.isTimerEnabled {
                    ToolbarItem(placement: .principal) {
                        Button(action: {
                            if viewModel.isTimerRunning {
                                viewModel.stopTimer()
                            } else {
                                viewModel.startTimer()
                            }
                        }) {
                            HStack(spacing: 4) {
                                Image(systemName: viewModel.isTimerRunning ? "pause.circle.fill" : "play.circle.fill")
                                Text("\(viewModel.remainingTime/60):\(String(format: "%02d", viewModel.remainingTime%60))")
                            }
                            .font(.custom("Georgia", size: 18))
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                        }
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button(action: { showingDistributionSheet = true }) {
                        Image(systemName: "scroll")
                            .font(.title2)
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                    }
                }
            }
            .sheet(isPresented: $showingRoleSheet) {
                RoleListView(players: viewModel.players)
                    .environmentObject(viewModel)
            }
            .sheet(isPresented: $showingDistributionSheet) {
                RoleDistributionView(distribution: $viewModel.roleDistribution)
                    .environmentObject(viewModel)
            }
            .alert(Translations.text(for: "redistribute_roles", language: viewModel.selectedLanguage), isPresented: $showingRedistributeAlert) {
                Button(Translations.text(for: "cancel", language: viewModel.selectedLanguage), role: .cancel) {}
                Button(Translations.text(for: "redistribute_roles", language: viewModel.selectedLanguage), role: .destructive) {
                    withAnimation {
                        viewModel.distributeRoles()
                        showingRoleSheet = true
                    }
                }
            } message: {
                Text(Translations.text(for: "redistribute_warning", language: viewModel.selectedLanguage))
            }
            .alert(Translations.text(for: "delete_player", language: viewModel.selectedLanguage), isPresented: $showingDeleteAlert, presenting: playerToDelete) { player in
                Button(Translations.text(for: "cancel", language: viewModel.selectedLanguage), role: .cancel) {}
                Button(Translations.text(for: "delete", language: viewModel.selectedLanguage), role: .destructive) {
                    withAnimation {
                        if let index = viewModel.players.firstIndex(where: { $0.id == player.id }) {
                            viewModel.players.remove(at: index)
                        }
                    }
                }
            } message: { player in
                Text("\(player.name) \(Translations.text(for: "delete_player_warning", language: viewModel.selectedLanguage))")
            }
            .alert(Translations.text(for: "delete_all", language: viewModel.selectedLanguage), isPresented: $showingDeleteAllAlert) {
                Button(Translations.text(for: "cancel", language: viewModel.selectedLanguage), role: .cancel) {}
                Button(Translations.text(for: "delete", language: viewModel.selectedLanguage), role: .destructive) {
                    withAnimation {
                        viewModel.players.removeAll()
                    }
                }
            } message: {
                Text(Translations.text(for: "delete_all_warning", language: viewModel.selectedLanguage))
            }
            .sheet(isPresented: $showingSettingsSheet) {
                NavigationView {
                    ZStack {
                        Color(red: 0.3, green: 0.2, blue: 0.1)
                            .ignoresSafeArea()
                        
                        VStack(spacing: 20) {
                            List {
                                Section(header: Text(Translations.text(for: "language", language: viewModel.selectedLanguage))
                                    .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                    .font(.custom("Georgia", size: 18))) {
                                    ForEach(Language.allCases, id: \.self) { language in
                                        Button(action: {
                                            viewModel.selectedLanguage = language
                                        }) {
                                            HStack {
                                                Text(language.flagEmoji)
                                                    .font(.title2)
                                                Text(language.rawValue)
                                                    .foregroundColor(Color(red: 0.95, green: 0.9, blue: 0.8))
                                                Spacer()
                                                if viewModel.selectedLanguage == language {
                                                    Image(systemName: "checkmark")
                                                        .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                                }
                                            }
                                        }
                                        .listRowBackground(Color(red: 0.3, green: 0.2, blue: 0.1))
                                    }
                                }
                                
                                Section(header: Text(Translations.text(for: "timer_settings", language: viewModel.selectedLanguage))
                                    .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                    .font(.custom("Georgia", size: 18))) {
                                    
                                    Toggle(isOn: $viewModel.isTimerEnabled) {
                                        Text(Translations.text(for: "timer_enabled", language: viewModel.selectedLanguage))
                                            .foregroundColor(Color(red: 0.95, green: 0.9, blue: 0.8))
                                    }
                                    .listRowBackground(Color(red: 0.3, green: 0.2, blue: 0.1))
                                    .tint(Color(red: 0.8, green: 0.7, blue: 0.3))
                                    
                                    if viewModel.isTimerEnabled {
                                        Picker("", selection: $viewModel.timerDuration) {
                                            ForEach([60, 120, 180, 240, 300], id: \.self) { seconds in
                                                if seconds < 60 {
                                                    Text("\(seconds) \(Translations.text(for: "seconds", language: viewModel.selectedLanguage))")
                                                } else {
                                                    Text("\(seconds/60) \(Translations.text(for: "minutes", language: viewModel.selectedLanguage))")
                                                }
                                            }
                                        }
                                        .pickerStyle(.menu)
                                        .listRowBackground(Color(red: 0.3, green: 0.2, blue: 0.1))
                                        .accentColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                    }
                                }
                            }
                            .scrollContentBackground(.hidden)
                        }
                    }
                    .navigationTitle(Translations.text(for: "settings", language: viewModel.selectedLanguage))
                    .navigationBarTitleDisplayMode(.inline)
                    .toolbar {
                        ToolbarItem(placement: .navigationBarTrailing) {
                            Button(Translations.text(for: "done", language: viewModel.selectedLanguage)) {
                                showingSettingsSheet = false
                            }
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                        }
                    }
                }
            }
        }
    }
}

struct MedievalTextFieldStyle: TextFieldStyle {
    func _body(configuration: TextField<Self._Label>) -> some View {
        configuration
            .padding()
            .background(
                RoundedRectangle(cornerRadius: 15)
                    .fill(Color(red: 0.95, green: 0.9, blue: 0.8))
                    .overlay(
                        RoundedRectangle(cornerRadius: 15)
                            .stroke(Color(red: 0.8, green: 0.7, blue: 0.3), lineWidth: 1)
                    )
            )
            .foregroundColor(Color(red: 0.2, green: 0.1, blue: 0.1))
    }
}

struct PlayerRow: View {
    let player: Player
    @EnvironmentObject var viewModel: GameViewModel
    
    var roleText: String {
        if let role = player.role {
            return role.localizedName(language: viewModel.selectedLanguage, customRoleName: viewModel.customRoleName)
        }
        return ""
    }
    
    var roleDescriptionText: String {
        if let role = player.role {
            return role.localizedDescription(language: viewModel.selectedLanguage, customRoleDescription: viewModel.customRoleDescription)
        }
        return ""
    }
    
    var body: some View {
        GeometryReader { geometry in
            HStack {
                VStack(alignment: .leading, spacing: geometry.size.height * 0.05) {
                    Text(player.name)
                        .font(.custom("Georgia", size: UIScreen.isSmallDevice ? 16 : 18))
                        .foregroundColor(Color(red: 0.95, green: 0.9, blue: 0.8))
                        .strikethrough(player.isDead)
                    
                    if let role = player.role {
                        Text(roleDescriptionText)
                            .font(.custom("Georgia", size: UIScreen.isSmallDevice ? 12 : 14))
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                            .lineLimit(2)
                            .opacity(player.isDead ? 0.5 : 1)
                    }
                }
                
                Spacer()
                
                if let role = player.role {
                    Text(roleText)
                        .font(.custom("Georgia", size: UIScreen.isSmallDevice ? 14 : 16))
                        .minimumScaleFactor(0.5)
                        .lineLimit(1)
                        .frame(width: geometry.size.width * 0.3, height: geometry.size.height * 0.6)
                        .background(
                            RoundedRectangle(cornerRadius: 12)
                                .fill(player.isDead ? Color.gray : role.backgroundColor)
                                .overlay(
                                    RoundedRectangle(cornerRadius: 12)
                                        .stroke(Color(red: 0.8, green: 0.7, blue: 0.3), lineWidth: 1)
                                )
                        )
                }
            }
            .padding(.horizontal, geometry.size.width * 0.04)
            .padding(.vertical, geometry.size.height * 0.1)
            .background(
                RoundedRectangle(cornerRadius: 20)
                    .fill(player.isDead ? Color(red: 0.2, green: 0.2, blue: 0.2) : Color(red: 0.3, green: 0.2, blue: 0.1))
                    .overlay(
                        RoundedRectangle(cornerRadius: 20)
                            .stroke(Color(red: 0.8, green: 0.7, blue: 0.3), lineWidth: 1)
                    )
                    .shadow(color: Color.black.opacity(0.3), radius: 10)
            )
            .contentShape(Rectangle())
        }
        .frame(height: UIScreen.screenHeight * 0.12)
    }
}

struct RoleListView: View {
    let players: [Player]
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var viewModel: GameViewModel
    
    var body: some View {
        NavigationView {
            ZStack {
                Color(red: 0.3, green: 0.2, blue: 0.1)
                    .ignoresSafeArea()
                
                Image(systemName: "seal.fill")
                    .resizable()
                    .aspectRatio(contentMode: .fit)
                    .foregroundColor(.white.opacity(0.03))
                    .frame(width: 200, height: 200)
                    .rotationEffect(.degrees(45))
                    .position(x: UIScreen.main.bounds.width * 0.8, y: UIScreen.main.bounds.height * 0.2)
                
                ScrollView {
                    LazyVStack(spacing: 16) {
                        ForEach(players) { player in
                            if let role = player.role {
                                VStack(alignment: .leading, spacing: 8) {
                                    Text(player.name)
                                        .font(.custom("Georgia", size: 22))
                                        .bold()
                                        .foregroundColor(Color(red: 0.95, green: 0.9, blue: 0.8))
                                    
                                    HStack {
                                        Text(role.localizedName(language: viewModel.selectedLanguage, customRoleName: viewModel.customRoleName))
                                            .font(.custom("Georgia", size: 20))
                                        
                                        Spacer()
                                        
                                        Text(role.localizedDescription(language: viewModel.selectedLanguage, customRoleDescription: viewModel.customRoleDescription))
                                            .font(.custom("Georgia", size: 16))
                                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                            .multilineTextAlignment(.trailing)
                                    }
                                }
                                .padding()
                                .background(
                                    RoundedRectangle(cornerRadius: 20)
                                        .fill(role.backgroundColor.opacity(0.3))
                                        .overlay(
                                            RoundedRectangle(cornerRadius: 20)
                                                .stroke(Color(red: 0.8, green: 0.7, blue: 0.3), lineWidth: 1)
                                        )
                                )
                                .padding(.horizontal)
                            }
                        }
                    }
                    .padding(.vertical)
                }
            }
            .navigationTitle(Translations.text(for: "roles", language: viewModel.selectedLanguage))
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button(Translations.text(for: "close", language: viewModel.selectedLanguage)) {
                        dismiss()
                    }
                    .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                }
            }
        }
    }
}

struct RoleDistributionView: View {
    @Binding var distribution: [GameRole: Int]
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var viewModel: GameViewModel
    @State private var showingCustomRoleSheet = false
    @State private var newRoleName = ""
    @State private var newRoleDescription = ""
    
    var body: some View {
        NavigationView {
            ZStack {
                Color(red: 0.3, green: 0.2, blue: 0.1)
                    .ignoresSafeArea()
                
                Image(systemName: "seal.fill")
                    .resizable()
                    .aspectRatio(contentMode: .fit)
                    .foregroundColor(.white.opacity(0.03))
                    .frame(width: 200, height: 200)
                    .rotationEffect(.degrees(45))
                    .position(x: UIScreen.main.bounds.width * 0.8, y: UIScreen.main.bounds.height * 0.2)
                
                ScrollView {
                    VStack(spacing: 16) {
                        ForEach(GameRole.allCases) { role in
                            if role != .custom || (role == .custom && viewModel.customRoleName != nil) {
                                HStack {
                                    HStack {
                                        Text(role.localizedName(language: viewModel.selectedLanguage, customRoleName: viewModel.customRoleName))
                                            .font(.custom("Georgia", size: 18))
                                            .foregroundColor(Color(red: 0.95, green: 0.9, blue: 0.8))
                                        
                                        Text(role.localizedDescription(language: viewModel.selectedLanguage, customRoleDescription: viewModel.customRoleDescription))
                                            .font(.custom("Georgia", size: 14))
                                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                    }
                                    
                                    Spacer()
                                    
                                    HStack {
                                        Button(action: {
                                            if let current = distribution[role], current > 0 {
                                                distribution[role] = current - 1
                                            }
                                        }) {
                                            Image(systemName: "minus.circle.fill")
                                                .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                                .font(.title2)
                                        }
                                        
                                        Text("\(distribution[role] ?? 0)")
                                            .font(.custom("Georgia", size: 20))
                                            .foregroundColor(Color(red: 0.95, green: 0.9, blue: 0.8))
                                            .frame(width: 40)
                                        
                                        Button(action: {
                                            let current = distribution[role] ?? 0
                                            if current < 10 {
                                                distribution[role] = current + 1
                                            }
                                        }) {
                                            Image(systemName: "plus.circle.fill")
                                                .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                                                .font(.title2)
                                        }
                                    }
                                }
                                .padding()
                                .background(
                                    RoundedRectangle(cornerRadius: 15)
                                        .fill(role.backgroundColor.opacity(0.2))
                                        .overlay(
                                            RoundedRectangle(cornerRadius: 15)
                                                .stroke(Color(red: 0.8, green: 0.7, blue: 0.3), lineWidth: 1)
                                        )
                                )
                            }
                        }
                        
                        Button(action: {
                            showingCustomRoleSheet = true
                        }) {
                            HStack {
                                Image(systemName: "plus.circle.fill")
                                Text(Translations.text(for: "add_custom_role", language: viewModel.selectedLanguage))
                                    .font(.custom("Georgia", size: 18))
                            }
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                            .padding()
                            .frame(maxWidth: .infinity)
                            .background(
                                RoundedRectangle(cornerRadius: 15)
                                    .stroke(Color(red: 0.8, green: 0.7, blue: 0.3), lineWidth: 1)
                            )
                        }
                        .padding(.top)
                    }
                    .padding()
                }
            }
            .navigationTitle(Translations.text(for: "role_distribution", language: viewModel.selectedLanguage))
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button(Translations.text(for: "done", language: viewModel.selectedLanguage)) {
                        dismiss()
                    }
                    .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                }
            }
            .sheet(isPresented: $showingCustomRoleSheet) {
                NavigationView {
                    ZStack {
                        Color(red: 0.3, green: 0.2, blue: 0.1)
                            .ignoresSafeArea()
                        
                        VStack(spacing: 20) {
                            TextField(Translations.text(for: "custom_role_name", language: viewModel.selectedLanguage), text: $newRoleName)
                                .textFieldStyle(MedievalTextFieldStyle())
                                .padding()
                            
                            TextField(Translations.text(for: "custom_role_description", language: viewModel.selectedLanguage), text: $newRoleDescription)
                                .textFieldStyle(MedievalTextFieldStyle())
                                .padding()
                        }
                        .padding()
                    }
                    .navigationTitle(Translations.text(for: "add_custom_role", language: viewModel.selectedLanguage))
                    .navigationBarTitleDisplayMode(.inline)
                    .toolbar {
                        ToolbarItem(placement: .navigationBarTrailing) {
                            Button(Translations.text(for: "add", language: viewModel.selectedLanguage)) {
                                if !newRoleName.isEmpty {
                                    viewModel.customRoleName = newRoleName
                                    viewModel.customRoleDescription = newRoleDescription
                                    distribution[.custom] = 0
                                    showingCustomRoleSheet = false
                                }
                            }
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                        }
                        
                        ToolbarItem(placement: .navigationBarLeading) {
                            Button(Translations.text(for: "cancel", language: viewModel.selectedLanguage)) {
                                showingCustomRoleSheet = false
                            }
                            .foregroundColor(Color(red: 0.8, green: 0.7, blue: 0.3))
                        }
                    }
                }
            }
        }
    }
}

#Preview {
    ContentView()
}
